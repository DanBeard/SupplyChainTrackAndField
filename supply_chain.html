<html>
<head>
 <style>
     #gamecanvas {
         border:10px solid black; margin:auto;background: #87ceeb;
     }
 </style>
</head>

<body style="margin:0; padding:0; width:100%; height:100%; background: black">

<div id="container" style="height: 100%; width:100%;
    display: flex; align-content: center; align-items: center;


">
<canvas id="gamecanvas" width="1200" height="800" >

</canvas>
</div>


<div style="display:none;">
    <img id="cpu"
         src="/sprites/cpu.png">
    <img id="player1"
         src="/sprites/player1.png">
    <img id="player2"
         src="/sprites/player1.png">
    <img id="player3"
         src="/sprites/player1.png">
    <img id="bg"
         src="/sprites/bg.png">
</div>

<script>


    function init(){



        var canvasWidth = 1400;
        var canvasHeight = 800;
        var ctx = document.getElementById('gamecanvas').getContext('2d');
        const playerSprites = [
            document.getElementById('cpu'),
            document.getElementById('player1'),
            document.getElementById('player2'),
            document.getElementById('player3'),
        ];
        var bgSprites = document.getElementById('bg');
        var player1Width = 19; var player1Height = 38;

        var spriteScale = 2.5;

        // SPRITE HELPER FUNCS
        function drawSprite(img, canvasX, canvasY, frameX, frameY, width, height, scale) {
            var scaledWidth = scale * width;
            var scaledHeight = scale * height;
            ctx.drawImage(img,
                frameX, frameY, width, height,
                canvasX, canvasY, scaledWidth, scaledHeight);
        }

        function drawPlayerSprite(playerIdx, state, canvasX, canvasY) {
            //[x,y,width]
            var sprite_info = {
                idle:  [0, 4, 19, 32],
                mark: [176, 4, 29, 32],
                set: [208, 4, 32, 32],
                run0:  [2, 40, 23, 32],
                run1:  [25, 40, 23, 32],
                run2:  [46, 40, 23, 32],
                run3:  [72, 40, 23, 32],
                run4:  [96, 45, 31, 28],
                run5:  [130, 41, 31, 32],

            };
            var info =  sprite_info[state];
            var sprites = playerSprites[playerIdx];
            drawSprite(sprites, canvasX, canvasY,info[0], info[1], info[2], info[3], spriteScale);
        }

        function drawBgSprite(sprite, canvasX, canvasY) {
            var sprite_info = {
                track: [3, 17, 28, 25],
                grass: [3, 51, 257, 24],
                wall: [91, 110, 28, 25],
                fans: [120, 110, 28, 22],
                fansFlash: [149, 110, 28, 22],

            };
            var info =  sprite_info[sprite];
            drawSprite(bgSprites, canvasX, canvasY,info[0], info[1], info[2], info[3], spriteScale);
        }

        const pixelToM = ~~(canvasWidth / 20); // about 20 meters per screen

        // draw the distance marker itself
        function drawMarker(text, x,y) {
            ctx.fillStyle = "black";
            ctx.beginPath();
            ctx.rect(x-25, y, 50, 25);
            ctx.fill();
            // now the text
            ctx.font = "30px \"Lucida Console\", Monaco, monospace";
            ctx.fillStyle = "white";
            ctx.textAlign = "center";
            ctx.fillText(text, x, y + 25);
        }

        // Draw the distance markers for a player (10, 20, 30, etc)
        function drawDistanceMarkers(playerState) {
            // draw the user's label
            drawMarker(playerState.name, 100, playerState.Y+66 );
            let x = ~~(playerState.X - 10*pixelToM);
            let distance = ~~(playerState.distance - 10); // start BEHIND the player so it doesnt dissppear
            let xShift = (playerState.distance - 10 - distance) * pixelToM; // shift the drawing for smooth animation in floating point distances
            while(x <= canvasWidth) {
                if(distance % 10 === 0 && distance > 0 ) {
                    drawMarker(distance, x - xShift, playerState.Y+86)
                }
                distance++;
                x += pixelToM
            }
        }
        function drawBackground() {
            // draw the grass sprites
            const grassWidth=250*spriteScale;
            const wallWidth = 28*spriteScale; // also fan width
            const trackWidth =  25*spriteScale;
            const trackPlayerOffset = 50;

            let x = 0;

            x=0;
            while(x<=canvasWidth) {
                drawBgSprite("grass", x, state.cpu.Y );
                drawBgSprite("grass", x, state.player1.Y );
                drawBgSprite("grass", x, state.player2.Y );
                drawBgSprite("grass", x, state.player3.Y );
                drawBgSprite("grass", x, canvasHeight-75 );
                x+=grassWidth;
            }

            const wallY =  state.cpu.Y -50;
            x=0;
            while(x<canvasWidth) {
                drawBgSprite("fans", x, wallY-50);
                drawBgSprite("wall", x, wallY);
                x+=wallWidth;
            }

            // draw the tracks
            x=0;
            while(x <= canvasWidth) {

                drawBgSprite("track", x, state.cpu.Y + trackPlayerOffset);
                drawBgSprite("track", x, state.player1.Y + trackPlayerOffset);
                drawBgSprite("track", x, state.player2.Y + trackPlayerOffset);
                drawBgSprite("track", x, state.player3.Y + trackPlayerOffset);

                x += trackWidth;
            }

            // now draw the numbers for each player's tracks
            drawDistanceMarkers(state.cpu);
            drawDistanceMarkers(state.player1);
            drawDistanceMarkers(state.player2);
            drawDistanceMarkers(state.player3);
        }

        //STATE
        var framenum = 0;

        var state = {

            cpu : {
                X: 250,
                Y: 320, // hard coded Y values, since... they never change
                name: "CPU",
                action: "idle", // idle, mark, set or running
                runAnimCounter: 0, // which frame of runANim to use if rnning
                distance: 0, //"distance" player has run in like, meters or something.
                maxDistance: 100
            },
            player1 : {
                X: 250,
                Y: 420, // hard coded Y values, since... they never change
                name: "P1",
                action: "idle", // idle, mark, set or running
                runAnimCounter: 0, // which frame of runANim to use if rnning
                distance: 0, //"distance" player has run in like, meters or something.
                maxDistance: 500
            },
            player2 : {
                X: 250,
                Y: 520, // hard coded Y values, since... they never change
                name: "P2",
                action: "idle", // idle, mark, set or running
                runAnimCounter: 0, // which frame of runANim to use if rnning
                distance: 0, //"distance" player has run in like, meters or something.
                maxDistance: 500
            },
            player3 : {
                X: 250,
                Y: 620, // hard coded Y values, since... they never change
                name: "P3",
                action: "idle", // idle, mark, set or running
                runAnimCounter: 0, // which frame of runANim to use if rnning
                distance: 0, //"distance" player has run in like, meters or something.
                maxDistance: 500
            },
        };
        document.state = state; // for easy tweaking.


        // DRAW HELPER FUNCS
        const playerNames = ["cpu","player1","player2","player3"];
        function drawPlayer(playernum){
            const playername = playerNames[playernum];
            const playerState = state[playername];
            if(playerState.action === "running") {
                drawPlayerSprite(playernum, "run"+playerState.runAnimCounter, playerState.X, playerState.Y);
                playerState.runAnimCounter = (playerState.runAnimCounter + 1) % 6; // wrap around
            }
            else {
                drawPlayerSprite(playernum, playerState.action, playerState.X, playerState.Y);
            }
        }
        // MAIN DRAW FUNC
        function draw() {
            framenum++;
            framenum = framenum % 100; // 100 options to slow frames down
            // schedule nex draw
            window.requestAnimationFrame(draw);

            // only do this every 3 frames
            if(framenum % 4 === 0) {
                ctx.clearRect(0, 0, canvasWidth, canvasHeight); // clear canvas
                drawBackground();
                drawPlayer(0);
                drawPlayer(1);
                drawPlayer(2);
                drawPlayer(3);
                if(document.drawCrt) document.drawCrt();
            }

        }

        draw();

    }

    init();


</script>
<!-- CRT screen effect -->
<script src="js/glfx.js"> </script>
<script src="js/crt.js"> </script>

</body>
</html>
